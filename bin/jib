# @describe Jib helps the crane hoist the cargo.
# @version 0.1.1

# @cmd deploy a proxy admin contract
# @alias dpa
# @option --private-key!
# @option --rpc-url=http://localhost:8545 The url of the RPC endpoint.
# @option --block-explorer-api-key=ETHERSCAN_API_KEY the api key for the block explorer
deployProxyAdmin() {
  PRIVATE_KEY=$argc_private_key forge script \
    script/Deploy.s.sol:DeployScript --sig "deployProxyAdmin()" \
    --rpc-url $argc_rpc_url --broadcast --verify -vvvv \
    --etherscan-api-key "${!argc_block_explorer_api_key}" \
    --optimize --optimizer-runs 1000000
}

# @cmd deploy a governance token implementation contract
# @alias dgi
# @option --private-key!
# @option --rpc-url=http://localhost:8545 The url of the RPC endpoint.
# @option --block-explorer-api-key=ETHERSCAN_API_KEY the api key for the block explorer
deployGovTokenImpl() {
  PRIVATE_KEY=$argc_private_key forge script \
    script/Deploy.s.sol:DeployScript --sig "deployGovernanceTokenImpl()" \
    --rpc-url $argc_rpc_url --broadcast --verify -vvvv \
    --etherscan-api-key "${!argc_block_explorer_api_key}" \
    --optimize --optimizer-runs 1000000
}

# @cmd deploy a membership token implementation contract
# @alias dmi
# @option --private-key!
# @option --rpc-url=http://localhost:8545 The url of the RPC endpoint.
# @option --block-explorer-api-key=ETHERSCAN_API_KEY the api key for the block explorer
deployMemTokenImpl() {
  PRIVATE_KEY=$argc_private_key forge script \
    script/Deploy.s.sol:DeployScript --sig "deployMembershipTokenImpl()" \
    --rpc-url $argc_rpc_url --broadcast --verify -vvvv \
    --etherscan-api-key "${!argc_block_explorer_api_key}" \
    --optimize --optimizer-runs 17500
}

# @cmd deploy an instance of the governance token
# @alias dgt
# @arg proxy-admin! the address of the proxy admin contract
# @arg implementation! the address of the implementation contract
# @arg contract-admin! the address entitled to call admin functions
# @option -n --name! the name of the token
# @option -s --symbol! the symbol for the token
# @option -c --supply-cap! the maximum supply of the token
# @option --private-key!
# @option --rpc-url=http://localhost:8545 The url of the RPC endpoint.
# @option --block-explorer-api-key=ETHERSCAN_API_KEY the api key for the block explorer
deployGovToken() {
  PRIVATE_KEY=$argc_private_key forge script \
    script/Deploy.s.sol:DeployScript $argc_proxy_admin $argc_implementation \
    $argc_contract_admin "$argc_name" $argc_symbol $argc_supply_cap \
    --sig "deployGovernanceToken(address,address,address,string,string,uint256)" \
    --rpc-url $argc_rpc_url --broadcast --verify -vvvv \
    --etherscan-api-key "${!argc_block_explorer_api_key}" \
    --optimize --optimizer-runs 1000000
}

# @cmd deploy an instance of the membership token
# @alias dmt
# @arg proxy-admin! the address of the proxy admin contract
# @arg implementation! the address of the implementation contract
# @arg contract-admin! the address entitled to call admin functions
# @option -n --name! the name of the token
# @option -s --symbol! the symbol for the token
# @option -u --base-uri! the base uri for the token metadata
# @option --private-key!
# @option --rpc-url=http://localhost:8545 The url of the RPC endpoint.
# @option --block-explorer-api-key=POLYGONSCAN_API_KEY the api key for the block explorer
deployMemToken() {
  PRIVATE_KEY=$argc_private_key forge script \
    script/Deploy.s.sol:DeployScript $argc_proxy_admin $argc_implementation \
    $argc_contract_admin "$argc_name" $argc_symbol $argc_base_uri \
    --sig "deployMembershipToken(address,address,address,string,string,string)" \
    --rpc-url $argc_rpc_url --verify --broadcast -vvvv \
    --etherscan-api-key "${!argc_block_explorer_api_key}" \
    --optimize --optimizer-runs 17500
}

# @cmd upgrade a governance token
# @alias ugt
# @arg proxy-admin! the address of the proxy admin
# @arg transparent-proxy! the address of the transparent proxy to upgrade
# @arg implementation! the address of the implementation to upgrade to
# @option --private-key!
# @option --rpc-url=http://localhost:8545 The url of the RPC endpoint.
upgradeGovToken() {
  PRIVATE_KEY=$argc_private_key forge script \
    script/Upgrade.s.sol:UpgradeScript $argc_proxy_admin \
    $argc_transparent_proxy $argc_implementation \
    --sig "upgradeGovernanceToken(address,address,address)" \
    --rpc-url $argc_rpc_url --broadcast --verify -vvvv
}

# @cmd upgrade a membership token
# @alias umt
# @arg proxy-admin! the address of the proxy admin
# @arg transparent-proxy! the address of the transparent proxy to upgrade
# @arg implementation! the address of the implementation to upgrade to
# @option --private-key!
# @option --rpc-url=http://localhost:8545 The url of the RPC endpoint.
upgradeMemToken() {
  PRIVATE_KEY=$argc_private_key forge script \
    script/Upgrade.s.sol:UpgradeScript \
    $argc_proxy_admin $argc_transparent_proxy $argc_implementation \
    --sig "upgradeMembershipToken(address,address,address)" \
    --rpc-url $argc_rpc_url --broadcast --verify -vvvv
}

# @cmd deploy and upgrade a membership token
# @alias dumt
# @arg proxy-admin! the address of the proxy admin
# @arg transparent-proxy! the address of the transparent proxy to upgrade
# @option --private-key!
# @option --rpc-url=http://localhost:8545 The url of the RPC endpoint.
# @option --block-explorer-api-key=POLYGONSCAN_API_KEY the api key for the block explorer
deployAndUpgradeMemToken() {
  PRIVATE_KEY=$argc_private_key forge script \
    script/Upgrade.s.sol:UpgradeScript \
    $argc_proxy_admin $argc_transparent_proxy \
    --sig "deployAndUpgradeMembershipToken(address,address)" \
    --rpc-url $argc_rpc_url --broadcast --verify -vvvv \
    --etherscan-api-key "${!argc_block_explorer_api_key}" \
    --optimize --optimizer-runs 17500
}

# @cmd deploy and upgrade a governance token
# @alias dugt
# @arg proxy-admin! the address of the proxy admin
# @arg transparent-proxy! the address of the transparent proxy to upgrade
# @option --private-key!
# @option --rpc-url=http://localhost:8545 The url of the RPC endpoint.
# @option --block-explorer-api-key=ETHERSCAN_API_KEY the api key for the block explorer
deployAndUpgradeGovToken() {
  PRIVATE_KEY=$argc_private_key forge script \
    script/Upgrade.s.sol:UpgradeScript $argc_proxy_admin $argc_transparent_proxy \
    --sig "deployAndUpgradeGovernanceToken(address,address)" \
    --rpc-url $argc_rpc_url --broadcast --verify -vvvv \
    --etherscan-api-key "${!argc_block_explorer_api_key}" \
    --optimize --optimizer-runs 1000000
}

# @cmd output test coverage data for the contracts
# @alias cov
# @flag --no-open do not open the coverage report in the browser
coverage() {
  forge coverage --report lcov
  lcov -r lcov.info "test/*" \
    -r lcov.info "script/*" "src/governor/lib/*" "src/utils/*" \
    -o lcov-filtered.info
  genhtml -o coverage/ lcov-filtered.info
  rm lcov.info lcov-filtered.info
  [ $argc_no_open ] || open coverage/index.html
}

# @cmd check storage layout against the last storage layout
# @alias check-storage
# @arg contract-name![OrigamiGovernanceToken|OrigamiMembershipToken] the name of the contract to check
checkStorage() {
  FILE_BASE=".storage-layout/.$argc_contract_name"
  forge inspect --pretty $argc_contract_name storage-layout >"$FILE_BASE.new"
  if [ -f "$FILE_BASE.old" ]; then
    diff -a --suppress-common-lines "$FILE_BASE.old" "$FILE_BASE.new"
  else
    echo "No previous storage layout found"
  fi
}

# @cmd grant mint/revoke permissions to wallets
# @alias grant-permissions
# @arg contract! the address of the token contract
# @arg file! the path to the file containing the addresses to grant permissions to (one per line)
# @option --private-key!
# @option --gas-price Override the gas price to use for the transaction.
# @option --rpc-url=http://localhost:8545 The url of the RPC endpoint.
grantPermissions() {
  ADDRESS_ARRAY=$(awk 'BEGIN { printf "[" } { if (NR == 1) printf "%s", $0; else printf ",%s", $0; } END { printf "]" }' $argc_file)
  PRIVATE_KEY=$argc_private_key forge script \
    script/Util.s.sol:GrantPermissions \
    $argc_contract $ADDRESS_ARRAY \
    --sig "run(address,address[])" \
    --rpc-url $argc_rpc_url --broadcast -vvvv \
    --gas-price "${argc_gas_price:-0}"
}

# @cmd check for mint/revoke permissions for wallets
# @alias check-permissions
# @arg contract! the address of the token contract
# @arg file! the path to the file containing the addresses to check permissions for (one per line)
# @option --rpc-url=http://localhost:8545 The url of the RPC endpoint.
# @flag --verbose print the addresses that have the permissions
checkPermissions() {
  REVOKER_ROLE="0xce3f34913921da558f105cefb578d87278debbbd073a8d552b5de0d168deee30"
  MINTER_ROLE="0x9f2df0fed2c77648de5860a4cc508cd0818c85b8b8a1ab4ceeef8d981c8956a6"
  FALSE="0x0000000000000000000000000000000000000000000000000000000000000000"

  while read -r address; do
    local REVOKER="$(cast call --rpc-url $argc_rpc_url $argc_contract "hasRole(bytes32,address)" $REVOKER_ROLE $address)"
    if [ $REVOKER = $FALSE ]; then
      echo "$address does not have the revoker role"
    elif [ $argc_verbose ]; then
      echo "$address has the revoker role"
    fi

    local MINTER="$(cast call --rpc-url $argc_rpc_url $argc_contract "hasRole(bytes32,address)" $MINTER_ROLE $address)"
    if [ $REVOKER = $FALSE ]; then
      echo "$address does not have the minter role"
    elif [ $argc_verbose ]; then
      echo "$address has the minter role"
    fi
  done <$argc_file
}

# @cmd check balances of wallets
# @alias check-balances
# @arg file! the path to the file containing the addresses to check balances for (one per line)
# @option --rpc-url=http://localhost:8545 The url of the RPC endpoint.
checkBalances() {
  while read -r address; do
    local BALANCE="$(cast balance --rpc-url $argc_rpc_url $address)"
    echo "$address has a balance of $BALANCE"
  done <$argc_file
}

# @cmd deploy all current governor diamond facets
# @alias deploy-facets
# @option --private-key!
# @option --rpc-url=http://localhost:8545 The url of the RPC endpoint.
# @flag --ignore-deploy-warning ignore the warning about deploying all facets
# @option --block-explorer-api-key=ETHERSCAN_API_KEY the api key for the block explorer
deployFacets() {
  if [ $argc_ignore_deploy_warning ]; then
    PRIVATE_KEY=$argc_private_key forge script \
      script/Governor.s.sol:DeployGovernorFacets \
      --etherscan-api-key "${!argc_block_explorer_api_key}" \
      --optimize --optimizer-runs 1000000 \
      --rpc-url $argc_rpc_url --broadcast --verify -vvvv
  else
    echo
    echo "-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-"
    echo "!!   WARNING: This will deploy all Governor Diamond Facets   !!"
    echo "-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-"
    echo
    echo " Unless this is the first deploy to a given chain, you probably"
    echo " don't want to do this. Facets are shared across all governor"
    echo " diamonds, so you almost never want to deploy _all_ of them."
    echo " If you are sure you want to deploy them, re-run this command"
    echo " with the --ignore-deploy-warning flag."
    echo
  fi
}

# @cmd deploy the governor diamond init contract
# @alias dgdi,deploy-governor-diamond-init
# @option --private-key!
# @option --rpc-url=http://localhost:8545 The url of the RPC endpoint.
# @option --block-explorer-api-key=ETHERSCAN_API_KEY the api key for the block explorer
deployGovernorDiamondInit() {
  PRIVATE_KEY=$argc_private_key forge script \
    script/Governor.s.sol:DeployGovernorDiamondInit \
    --optimize --optimizer-runs 1000000 \
    --etherscan-api-key "${!argc_block_explorer_api_key}" \
    --rpc-url $argc_rpc_url --broadcast --verify -vvvv
}

# @cmd deploy a governor diamond contract
# @alias dgd,deploy-governor-diamond
# @arg admin! the address of the admin
# @arg diamond-cut-facet! the address of the diamond cut facet
# @option --private-key!
# @option --rpc-url=http://localhost:8545 The url of the RPC endpoint.
# @option --block-explorer-api-key=ETHERSCAN_API_KEY the api key for the block explorer
deployGovernorDiamond() {
  PRIVATE_KEY=$argc_private_key forge script \
    script/Governor.s.sol:DeployGovernorDiamond \
    $argc_admin $argc_diamond_cut_facet \
    --sig "run(address,address)" \
    --optimize --optimizer-runs 1000000 \
    --etherscan-api-key "${!argc_block_explorer_api_key}" \
    --rpc-url $argc_rpc_url --broadcast --verify -vvvv
}

# @cmd deploy a governor timelock controller
# @alias dgtc,deploy-governor-timelock-controller
# @arg governor-diamond! the address of the governor diamond
# @arg timelock-delay the initial delay for the timelock, in seconds
# @option --private-key!
# @option --rpc-url=http://localhost:8545 The url of the RPC endpoint.
# @option --block-explorer-api-key=ETHERSCAN_API_KEY the api key for the block explorer
deployGovernorTimelockController() {
  PRIVATE_KEY=$argc_private_key forge script \
    script/Governor.s.sol:DeployGovernorTimelockController \
    $argc_governor_diamond $argc_timelock_delay \
    --sig "run(address,uint256)" \
    --optimize --optimizer-runs 1000000 \
    --etherscan-api-key "${!argc_block_explorer_api_key}" \
    --rpc-url $argc_rpc_url --broadcast --verify -vvvv
}

# @cmd apply local configuration to deployed governor and timelock instances
# @alias cg,configure-governor
# @arg init! the address of the governor diamond init
# @arg diamond! the address of the governor diamond
# @arg timelock! the address of the timelock controller
# @arg path! the path to the governor diamond config
# @option --private-key!
# @option --rpc-url=http://localhost:8545 The url of the RPC endpoint.
# @option --block-explorer-api-key=ETHERSCAN_API_KEY the api key for the block explorer
configureGovernor() {
  PRIVATE_KEY=$argc_private_key forge script \
    script/Governor.s.sol:GovernorInstance \
    $argc_init $argc_diamond $argc_timelock $argc_path \
    --sig "configure(address,address,address,string)" \
    --optimize --optimizer-runs 1000000 \
    --etherscan-api-key "${!argc_block_explorer_api_key}" \
    --rpc-url $argc_rpc_url --broadcast --verify -vvvv
}

eval $(argc "$0" "$@")
